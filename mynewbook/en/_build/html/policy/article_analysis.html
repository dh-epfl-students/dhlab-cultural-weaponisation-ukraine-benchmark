
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Protection Status &#8212; Tracking Wikipedia Weaponization and Cultural Heritage Manipulation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'policy/article_analysis';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="&lt;no title&gt;" href="policy_in_nutshell.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../welcome.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Tracking Wikipedia Weaponization and Cultural Heritage Manipulation - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Tracking Wikipedia Weaponization and Cultural Heritage Manipulation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    Welcome
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction.html">Introduction</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../data/index.html">Data collection and structure</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../data/data_collection.html">Data collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data/data_structure.html">Structure</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../analysis/weaponized_vs_nonweaponized/index.html">Weaponized vs. Non-weaponized analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../analysis/weaponized_vs_nonweaponized/users_contributions.html">User Contributions Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analysis/weaponized_vs_nonweaponized/users_metadata.html">User Metadata Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../analysis/weaponized_vs_nonweaponized/users_motivations.html">Users motivations</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../analysis/finegrained_analysis/index.html">Weaponizing users — Fine-grained analysis</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="simple">
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Article policy analysis</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="context.html">Why studying the Wikipedia Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="policy_in_details.html">Wikipedia Policy in details</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Protection Status</a></li>



</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=lab/tree/policy/article_analysis.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Binder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Binder logo" src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/policy/article_analysis.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Protection Status</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Protection Status</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#importance-and-grades-analysis">Importance and Grades Analysis</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vital-level">Vital Level</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#match-and-plot">Match and Plot</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mwparserfromhell</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;../../datas/final/large_db_preprocess.csv&#39;</span><span class="p">)</span>
<span class="n">articles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;article&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># articles look clean and ready to be used</span>
<span class="n">articles</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;2004 Ukrainian presidential election&#39;,
 &#39;2014 Russian annexation of Crimea&#39;,
 &#39;2014 pro-Russian unrest in Ukraine&#39;,
 &#39;2022 Russian invasion of Ukraine&#39;,
 &#39;Abortion in Ukraine&#39;,
 &#39;Administrative divisions of Ukraine&#39;,
 &#39;Alexander II of Russia&#39;,
 &#39;Armed Forces of Ukraine&#39;,
 &#39;Bessarabia&#39;,
 &#39;Buddhism in Ukraine&#39;,
 &#39;Bukovina&#39;,
 &#39;COVID-19 pandemic in Ukraine&#39;,
 &#39;Catherine the Great&#39;,
 &#39;Censuses in Ukraine&#39;,
 &#39;Christianity in Russia&#39;,
 &#39;Christmas in Ukraine&#39;,
 &#39;Communist Party of the Soviet Union&#39;,
 &#39;Crimea&#39;,
 &#39;Crimean Tatars&#39;,
 &#39;Culture of Ukraine&#39;,
 &#39;Demographics of Ukraine&#39;,
 &#39;Dissolution of the Soviet Union&#39;,
 &#39;Eastern Front (World War I)&#39;,
 &#39;Eastern Front (World War II)&#39;,
 &#39;Economy of Ukraine&#39;,
 &#39;Education in Ukraine&#39;,
 &#39;Epiphanius I of Ukraine&#39;,
 &#39;Euromaidan&#39;,
 &#39;Flag of Ukraine&#39;,
 &#39;Football in Ukraine&#39;,
 &#39;Foreign relations of Ukraine&#39;,
 &#39;Galicia (Eastern Europe)&#39;,
 &#39;Geography of Ukraine&#39;,
 &#39;Government of Ukraine&#39;,
 &quot;Government of the Ukrainian People&#39;s Republic in exile&quot;,
 &#39;History of Christianity in Ukraine&#39;,
 &#39;History of Crimea&#39;,
 &#39;History of Kyiv&#39;,
 &#39;History of Ukraine&#39;,
 &#39;History of the Russian Orthodox Church&#39;]
</pre></div>
</div>
</div>
</div>
<section id="protection-status">
<h1>Protection Status<a class="headerlink" href="#protection-status" title="Link to this heading">#</a></h1>
<p>We are first looking into the protection status feature as it is the easiest to retrieve. Indeed, the Wikimedia Action API does have a special parameter <code class="docutils literal notranslate"><span class="pre">prop</span> <span class="pre">=</span> <span class="pre">info</span></code>, <code class="docutils literal notranslate"><span class="pre">infoprop</span> <span class="pre">=</span> <span class="pre">protection</span></code> that allows us to gather this information.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">URL</span> <span class="o">=</span> <span class="s2">&quot;https://en.wikipedia.org/w/api.php&quot;</span>
<span class="n">HEADERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="s2">&quot;DH_Project/1.0 (https://www.epfl.ch/labs/dhlab/; maxime.garambois@epfl.ch)&quot;</span>
<span class="p">}</span>

<span class="c1"># allow us to know when to start our timeline to display the protection status evolution for each article </span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_article_creation_date</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prop&quot;</span><span class="p">:</span> <span class="s2">&quot;revisions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;rvlimit&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;rvprop&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp|user|comment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvdir&quot;</span><span class="p">:</span> <span class="s2">&quot;newer&quot;</span>  
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">if</span> <span class="s2">&quot;missing&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">rev</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;revisions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">),</span>
        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">)</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_article_protection_status</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the protection status of an article</span>
<span class="sd">    The status can be :</span>
<span class="sd">    - fully protected </span>
<span class="sd">    - semi-protected</span>
<span class="sd">    - template protected</span>
<span class="sd">    - ...</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">HEADERS</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">article_title</span><span class="p">,</span>
        <span class="s2">&quot;prop&quot;</span><span class="p">:</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span>
        <span class="s2">&quot;inprop&quot;</span><span class="p">:</span> <span class="s2">&quot;protection&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span>
    <span class="p">}</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="c1"># Extract page object (the pageid is unknown =&gt; key is not fixed)</span>
    <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">if</span> <span class="s2">&quot;missing&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;missing&quot;</span><span class="p">,</span> <span class="s2">&quot;protections&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">protections</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protection&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># If no protection entries → page is fully open</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">protections</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unprotected&quot;</span><span class="p">,</span> <span class="s2">&quot;protections&quot;</span><span class="p">:</span> <span class="p">[]}</span> 

    <span class="c1"># Convert the protection status to understand better</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;custom protection&quot;</span>
    <span class="k">for</span> <span class="n">prot</span> <span class="ow">in</span> <span class="n">protections</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
        <span class="n">level</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;edit&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;autoconfirmed&quot;</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;semi-protected&quot;</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;extendedconfirmed&quot;</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;extended-protected&quot;</span>
            <span class="k">elif</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;sysop&quot;</span><span class="p">:</span>
                <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;fully protected&quot;</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;move&quot;</span> <span class="ow">and</span> <span class="n">level</span> <span class="o">==</span> <span class="s2">&quot;sysop&quot;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;move-protected&quot;</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
        <span class="s2">&quot;protections&quot;</span><span class="p">:</span> <span class="n">protections</span>  <span class="c1"># raw list for further analysis</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_article_protection_history</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the full protection history of an article using MediaWiki logevents.</span>
<span class="sd">    Returns a sorted list of protection events including timestamp, action,</span>
<span class="sd">    protection levels, expiry, and comments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
    <span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">HEADERS</span><span class="p">)</span>

    <span class="n">events</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
            <span class="s2">&quot;list&quot;</span><span class="p">:</span> <span class="s2">&quot;logevents&quot;</span><span class="p">,</span>
            <span class="s2">&quot;letype&quot;</span><span class="p">:</span> <span class="s2">&quot;protect&quot;</span><span class="p">,</span>
            <span class="s2">&quot;letitle&quot;</span><span class="p">:</span> <span class="n">article_title</span><span class="p">,</span>
            <span class="s2">&quot;lelimit&quot;</span><span class="p">:</span> <span class="s2">&quot;max&quot;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">cont</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;logevents&quot;</span><span class="p">]:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">),</span>
                <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">),</span>
                <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">),</span>        <span class="c1"># protect / modify / unprotect / move_prot</span>
                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">),</span>

                <span class="c1"># details with levels and expiry (may be missing)</span>
                <span class="s2">&quot;protection&quot;</span><span class="p">:</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;details&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="p">}</span>
            <span class="n">events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

        <span class="c1"># Continue if there&#39;s more data</span>
        <span class="k">if</span> <span class="s2">&quot;continue&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;continue&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="c1"># Sort chronologically</span>
    <span class="n">events</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">events</span>

<span class="c1"># -</span>
<span class="c1"># Those methods will help us cleaning our API JSON output because the format may not be the same through the evolution</span>
<span class="c1"># of wikipedia</span>
<span class="c1"># -</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_old_protection</span><span class="p">(</span><span class="n">comment</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts old-style MediaWiki protection settings from a log comment.</span>
<span class="sd">    Example: &quot;edit war [edit=sysop:move=sysop]&quot;</span>
<span class="sd">    Returns dict: {&quot;edit&quot;: &quot;sysop&quot;, &quot;move&quot;: &quot;sysop&quot;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">comment</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">content</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>

    <span class="n">prot</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">rule</span><span class="p">:</span>
            <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rule</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">prot</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">prot</span>


<span class="k">def</span><span class="w"> </span><span class="nf">resolve_status</span><span class="p">(</span><span class="n">prot_dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert a dict of edit/move protection settings to a unified status string.</span>
<span class="sd">    Used for new-style AND old-style protections.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">edit</span> <span class="o">=</span> <span class="n">prot_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edit&quot;</span><span class="p">)</span>
    <span class="n">move</span> <span class="o">=</span> <span class="n">prot_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;move&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">edit</span> <span class="o">==</span> <span class="s2">&quot;sysop&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;fully protected&quot;</span>
    <span class="k">if</span> <span class="n">edit</span> <span class="o">==</span> <span class="s2">&quot;extendedconfirmed&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;extended-protected&quot;</span>
    <span class="k">if</span> <span class="n">edit</span> <span class="o">==</span> <span class="s2">&quot;autoconfirmed&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;semi-protected&quot;</span>
    <span class="k">if</span> <span class="n">move</span> <span class="o">==</span> <span class="s2">&quot;sysop&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;move-protected&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;unprotected&quot;</span>

<span class="c1"># -</span>
<span class="c1"># This function allow us to build our timeline by knowing when the protection status changed for a specific article</span>
<span class="c1"># This function was almost fully generated with an LLM.</span>
<span class="c1"># -</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_protection_timeline</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build chronological protection timeline with:</span>
<span class="sd">      - new-style MW protection data (post-2010)</span>
<span class="sd">      - old-style comment-embedded protection info (pre-2010)</span>

<span class="sd">    Output:</span>
<span class="sd">        [</span>
<span class="sd">          {&quot;start&quot;: datetime, &quot;end&quot;: datetime, &quot;status&quot;: &quot;unprotected&quot;},</span>
<span class="sd">          {&quot;start&quot;: datetime, &quot;end&quot;: datetime, &quot;status&quot;: &quot;semi-protected&quot;},</span>
<span class="sd">          ...</span>
<span class="sd">        ]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">events</span> <span class="o">=</span> <span class="n">get_article_protection_history</span><span class="p">(</span><span class="n">article_title</span><span class="p">)</span>

    <span class="c1"># If no protection events at all, we add always unprotected</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>
        <span class="c1"># Try to use creation date if available; otherwise return None/None</span>
        <span class="n">creation_info</span> <span class="o">=</span> <span class="n">get_article_creation_date</span><span class="p">(</span><span class="n">article_title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">creation_info</span> <span class="ow">and</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">creation_info</span><span class="p">:</span>
            <span class="n">creation_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span>
                <span class="n">creation_info</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">creation_dt</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unprotected&quot;</span>
            <span class="p">}]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[{</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;unprotected&quot;</span>
            <span class="p">}]</span>

    <span class="c1"># Initial state: article just born, unprotected </span>
    <span class="n">creation_info</span> <span class="o">=</span> <span class="n">get_article_creation_date</span><span class="p">(</span><span class="n">article_title</span><span class="p">)</span>
    <span class="n">creation_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span>
        <span class="n">creation_info</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">timeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_status</span> <span class="o">=</span> <span class="s2">&quot;unprotected&quot;</span>
    <span class="n">current_start</span> <span class="o">=</span> <span class="n">creation_dt</span>

    <span class="c1"># events should already be chronological, but just to be safe</span>
    <span class="n">events</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">e</span><span class="p">:</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">ev</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>
        <span class="n">protections</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;protection&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">comment</span> <span class="o">=</span> <span class="n">ev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        
        
        <span class="n">expiry_dates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">protections</span><span class="p">:</span>
            <span class="n">expiry</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;expiry&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">expiry</span> <span class="ow">and</span> <span class="n">expiry</span> <span class="o">!=</span> <span class="s1">&#39;infinite&#39;</span><span class="p">:</span>
                <span class="n">expiry_dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">expiry</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;+00:00&#39;</span><span class="p">)))</span>

        <span class="n">expiry_dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">expiry_dates</span><span class="p">)</span> <span class="k">if</span> <span class="n">expiry_dates</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># start by assuming status stays the same</span>
        <span class="n">new_status</span> <span class="o">=</span> <span class="n">current_status</span>
        <span class="c1"># Then we sepearate in multiple cases </span>
        <span class="c1"># Case 1: explicit unprotect </span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;unprotect&quot;</span><span class="p">:</span>
            <span class="n">new_status</span> <span class="o">=</span> <span class="s2">&quot;unprotected&quot;</span>

        <span class="c1"># Case 2: protect / modify / move_prot : set some level</span>
        <span class="k">elif</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;protect&quot;</span><span class="p">,</span> <span class="s2">&quot;modify&quot;</span><span class="p">,</span> <span class="s2">&quot;move_prot&quot;</span><span class="p">,</span> <span class="s2">&quot;move_protect&quot;</span><span class="p">):</span>
            <span class="n">prot_dict</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># (1) Try new-style protection entries from API</span>
            <span class="k">for</span> <span class="n">prot</span> <span class="ow">in</span> <span class="n">protections</span><span class="p">:</span>
                <span class="n">ptype</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>   <span class="c1"># &quot;edit&quot;, &quot;move&quot;, ...</span>
                <span class="n">level</span> <span class="o">=</span> <span class="n">prot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level&quot;</span><span class="p">)</span>  <span class="c1"># &quot;sysop&quot;, &quot;autoconfirmed&quot;, ...</span>
                <span class="k">if</span> <span class="n">ptype</span> <span class="ow">and</span> <span class="n">level</span><span class="p">:</span>
                    <span class="n">prot_dict</span><span class="p">[</span><span class="n">ptype</span><span class="p">]</span> <span class="o">=</span> <span class="n">level</span>

            <span class="c1"># (2) If nothing found, try old-style [edit=sysop:move=sysop]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">prot_dict</span><span class="p">:</span>
                <span class="n">old</span> <span class="o">=</span> <span class="n">parse_old_protection</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
                <span class="n">prot_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old</span><span class="p">)</span>

            <span class="c1"># (3) Resolve final status from prot_dict</span>
            <span class="n">new_status</span> <span class="o">=</span> <span class="n">resolve_status</span><span class="p">(</span><span class="n">prot_dict</span><span class="p">)</span>

        <span class="c1"># else: action not recognised (rare), keep current_status</span>

        <span class="c1"># If status changed, close previous interval and start a new one </span>
        <span class="k">if</span> <span class="n">new_status</span> <span class="o">!=</span> <span class="n">current_status</span><span class="p">:</span>
            <span class="c1"># close previous interval</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">current_start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">current_status</span>
            <span class="p">})</span>

            <span class="c1"># start new interval</span>
            <span class="n">current_status</span> <span class="o">=</span> <span class="n">new_status</span>
            <span class="n">current_start</span> <span class="o">=</span> <span class="n">timestamp</span>
            

        <span class="k">if</span> <span class="n">expiry_dt</span><span class="p">:</span>
            <span class="c1"># Close current interval at expiry</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">current_start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">expiry_dt</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">current_status</span>
            <span class="p">})</span>

            <span class="c1"># After expiry, status becomes unprotected until next event</span>
            <span class="n">current_status</span> <span class="o">=</span> <span class="s2">&quot;unprotected&quot;</span>
            <span class="n">current_start</span> <span class="o">=</span> <span class="n">expiry_dt</span>

    <span class="c1"># Close the last interval, ending at &quot;now&quot;</span>
    <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">current_start</span><span class="p">,</span>
        <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">current_status</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="n">timeline</span>

<span class="c1"># This function is converting the timeline computed using the &lt;build_protection_timeline&gt; function into a dataframe</span>
<span class="c1"># so we can merge this dataframe with our database. We will now be able to know what was the protection status of an</span>
<span class="c1"># article by the time the edit was made</span>

<span class="k">def</span><span class="w"> </span><span class="nf">timelines_to_dataframe</span><span class="p">(</span><span class="n">timelines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the timelines dict into a pandas DataFrame with:</span>
<span class="sd">    article | start | end | status | diff (days)</span>
<span class="sd">    Ensures all datetimes are UTC-aware to avoid subtraction errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">intervals</span> <span class="ow">in</span> <span class="n">timelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">intervals</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>

            <span class="c1"># Normalize timezone to UTC</span>
            <span class="k">if</span> <span class="n">start</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">end</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">end</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">end</span> <span class="o">=</span> <span class="n">end</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="c1"># Compute difference in days</span>
            <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">start</span> <span class="ow">and</span> <span class="n">end</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
                <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">diff_days</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="c1"># This plot function will allow us to visualize the evolution of the dataframe using a Grantt Style plot</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_protection_dataframe</span><span class="p">(</span><span class="n">timeline_df</span><span class="p">,</span> <span class="n">wanna_save_fig</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gantt-style plot for multiple articles.</span>
<span class="sd">    timelines: dict =&gt; {article_name: [intervals]}</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">PROTECTION_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;unprotected&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;semi-protected&quot;</span><span class="p">:</span> <span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;extended-protected&quot;</span><span class="p">:</span> <span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fully protected&quot;</span><span class="p">:</span> <span class="s2">&quot;#d62728&quot;</span><span class="p">,</span>
        <span class="s2">&quot;move-protected&quot;</span><span class="p">:</span> <span class="s2">&quot;#2ca02c&quot;</span><span class="p">,</span>   
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">timeline_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timeline_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;timeline_df is empty. Nothing to plot.&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">timeline_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">}</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;timeline_df is missing required columns: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Parse datetimes robustly</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>   <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Drop invalid intervals</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]]</span>
    
    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;After cleaning invalid dates/intervals, nothing remains to plot.&quot;</span><span class="p">)</span>

    <span class="c1"># Sort articles alphabetically, and intervals chronologically per article</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">])</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)))</span>

    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">for</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">articles</span><span class="p">):</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">))],</span>
                <span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                <span class="n">facecolors</span><span class="o">=</span><span class="n">PROTECTION_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Label (use earliest interval start for placement)</span>
        <span class="n">first_start</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">first_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">y_pos</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">article</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Styling like your original</span>
    <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>

    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">status</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">status</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">PROTECTION_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Protection Status&quot;</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wikipedia Protection Evolution Timeline&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save_fig</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig_title</span> <span class="o">=</span> <span class="s2">&quot;Wikipedia Protection Evolution Timeline&quot;</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fig_title</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Finally, this function is taking the dataframe converted from the timeline as well as our database and makes the </span>
<span class="c1"># matching process</span>

<span class="k">def</span><span class="w"> </span><span class="nf">match_protect_feature_with_df</span><span class="p">(</span><span class="n">protect_dataframe</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">protect_dataframe</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">protect_dataframe</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">)</span>
    <span class="n">protect_dataframe</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">protect_dataframe</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>   <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ISO8601&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span>
        <span class="n">date_df</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>    

        <span class="n">protect_subset</span> <span class="o">=</span> <span class="n">protect_dataframe</span><span class="p">[</span><span class="n">protect_dataframe</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span>
    
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tp</span> <span class="ow">in</span> <span class="n">protect_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">protect_start</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">protect_end</span>   <span class="o">=</span> <span class="n">tp</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
    
            <span class="k">if</span> <span class="n">protect_start</span> <span class="o">&lt;=</span> <span class="n">date_df</span> <span class="o">&lt;</span> <span class="n">protect_end</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
                <span class="k">break</span>    

    <span class="k">return</span> <span class="n">df</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">protection_timelines</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># needed to build the timelines and build the plot </span>
<span class="n">protection_hist</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># needed to check if the results of &#39;timelines&#39; is good</span>

<span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
    <span class="n">protection_timelines</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">build_protection_timeline</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">protection_hist</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_article_protection_history</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
<span class="n">df_protect</span> <span class="o">=</span> <span class="n">timelines_to_dataframe</span><span class="p">(</span><span class="n">protection_timelines</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># we are checking the dataframe structure to prepare for cleaning</span>
<span class="c1"># 1. do we have data for the 40 articles ? df_protect[&#39;article&#39;].nunique()</span>
<span class="c1"># 2. do we have the expected status name ? df_protect[&#39;status&#39;].unique()</span>
<span class="c1"># 3. is the diff value strictly positive ? df_protect[df_protect[&#39;diff&#39;] &lt; 0] otherwise it means that</span>
<span class="c1"># the &quot;end_date&quot; &lt; &quot;start_date&quot;</span>

<span class="nb">print</span><span class="p">(</span><span class="n">df_protect</span><span class="p">[</span><span class="s1">&#39;article&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">())</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_protect</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>40

[&#39;unprotected&#39; &#39;semi-protected&#39; &#39;extended-protected&#39; &#39;fully protected&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean_protection_df</span><span class="p">(</span><span class="n">protect_dataframe</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">protect_dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># we are dropping those lines because the 2022 Russian Invasion of Ukraine presents some nonsenses.</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_protect_clean</span> <span class="o">=</span> <span class="n">clean_protection_df</span><span class="p">(</span><span class="n">df_protect</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># now we are matching this dataframe with our database</span>
<span class="n">df_match_protect</span> <span class="o">=</span> <span class="n">match_protect_feature_with_df</span><span class="p">(</span><span class="n">df_protect_clean</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="n">df_match_protect_nan</span> <span class="o">=</span> <span class="n">df_match_protect</span><span class="p">[</span><span class="n">df_match_protect</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()]</span>
<span class="n">df_match_protect_nan</span><span class="p">[</span><span class="s1">&#39;article&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_protection_dataframe</span><span class="p">(</span><span class="n">df_protect_clean</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/90a1b9ff23ab4ea92006e2d0ef0ce5c1405b68b7c4c8bd3fb8bb71d388e7fb29.png" src="../_images/90a1b9ff23ab4ea92006e2d0ef0ce5c1405b68b7c4c8bd3fb8bb71d388e7fb29.png" />
</div>
</div>
</section>
<section id="importance-and-grades-analysis">
<h1>Importance and Grades Analysis<a class="headerlink" href="#importance-and-grades-analysis" title="Link to this heading">#</a></h1>
<p>We are now looking into the WikiProject importance feature as well as the grade assessement. Those two features are harder to get than the protection status since there is no special API parameters to retrieve those informations. We are forced to retrieve for each article every Talk Page revisions (since those feature are written in the Talk Page of an article). We are looking in those revisions banners or templates format that indicates the current importance status and grade assessement of a page.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WIKI_API</span> <span class="o">=</span> <span class="s2">&quot;https://en.wikipedia.org/w/api.php&quot;</span>
<span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;DH_Project/1.0 (maxime.garambois@epfl.ch)&quot;</span>
<span class="n">SLEEP</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">request_api</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send a request to the API with retry and user-agent.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WIKI_API</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># same idea as the protection status</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_article_creation_date</span><span class="p">(</span><span class="n">title</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prop&quot;</span><span class="p">:</span> <span class="s2">&quot;revisions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
        <span class="s2">&quot;rvlimit&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;rvprop&quot;</span><span class="p">:</span> <span class="s2">&quot;timestamp|user|comment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvdir&quot;</span><span class="p">:</span> <span class="s2">&quot;newer&quot;</span>  
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">URL</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">HEADERS</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

    <span class="k">if</span> <span class="s2">&quot;missing&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">rev</span> <span class="o">=</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;revisions&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
        <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">),</span>
        <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;comment&quot;</span><span class="p">)</span>
    <span class="p">}</span>

<span class="c1"># as explained, we are collection every article Talk Page revisions.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_talk_revisions</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch all wikitext revisions of the Talk:Article page.</span>
<span class="sd">    Returns a list of dicts: {rev_id, timestamp, content}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">talk_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Talk:</span><span class="si">{</span><span class="n">article_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prop&quot;</span><span class="p">:</span> <span class="s2">&quot;revisions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">talk_title</span><span class="p">,</span>
        <span class="s2">&quot;rvprop&quot;</span><span class="p">:</span> <span class="s2">&quot;ids|timestamp|content&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvslots&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvlimit&quot;</span><span class="p">:</span> <span class="s2">&quot;500&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">revisions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="n">cont</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request_api</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pages</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">if</span> <span class="s2">&quot;revisions&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;revisions&quot;</span><span class="p">]:</span>
                <span class="n">revisions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;rev_id&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;revid&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;slots&quot;</span><span class="p">][</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">})</span>

        <span class="k">if</span> <span class="s2">&quot;continue&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;continue&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">)</span>

    <span class="c1"># sort from oldest → newest</span>
    <span class="n">revisions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">revisions</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_metadata</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract:</span>
<span class="sd">      - class: Prefer class from {{WikiProject banner shell|class=...}} if present,</span>
<span class="sd">               otherwise fall back to class from the chosen WikiProject template.</span>
<span class="sd">      - importance: ONLY one value:</span>
<span class="sd">            * If WikiProject Ukraine exists -&gt; its importance</span>
<span class="sd">            * Else -&gt; importance from the first WikiProject template found</span>
<span class="sd">        (If no importance is present in the chosen template -&gt; None)</span>

<span class="sd">    Notes:</span>
<span class="sd">      - Uses brace-matching to safely extract full templates (handles nesting).</span>
<span class="sd">      - Tolerates whitespace, capitalization, and common talk-page formatting.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_templates_balanced</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">start_pattern</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all templates starting with start_pattern (case-insensitive),</span>
<span class="sd">        and return their full wikitext using brace matching.</span>
<span class="sd">        start_pattern should look like &#39;{{WikiProject&#39; or &#39;{{WikiProject banner shell&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">pat</span> <span class="o">=</span> <span class="n">start_pattern</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">lower</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">pat</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># Ensure it really starts with &#39;{{&#39;</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">text</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;{{&quot;</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">continue</span>

            <span class="c1"># Brace matching from j</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">j</span>
            <span class="k">while</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">two</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">k</span><span class="p">:</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">two</span> <span class="o">==</span> <span class="s2">&quot;{{&quot;</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">two</span> <span class="o">==</span> <span class="s2">&quot;}}&quot;</span><span class="p">:</span>
                    <span class="n">depth</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">templates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="n">j</span><span class="p">:</span><span class="n">k</span><span class="p">])</span>
                        <span class="k">break</span>
                    <span class="k">continue</span>
                <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># continue scanning after the start</span>
        <span class="k">return</span> <span class="n">templates</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_class</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="c1"># common variants</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;STUB&quot;</span><span class="p">:</span> <span class="s2">&quot;STUB&quot;</span><span class="p">,</span>
            <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span>
            <span class="s2">&quot;LIST&quot;</span><span class="p">:</span> <span class="s2">&quot;LIST&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FA&quot;</span><span class="p">:</span> <span class="s2">&quot;FA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;FL&quot;</span><span class="p">:</span> <span class="s2">&quot;FL&quot;</span><span class="p">,</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GA&quot;</span><span class="p">:</span> <span class="s2">&quot;GA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span>
            <span class="s2">&quot;NA&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_importance</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;Top&quot;</span><span class="p">,</span>
            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="s2">&quot;Mid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;middle&quot;</span><span class="p">:</span> <span class="s2">&quot;Mid&quot;</span><span class="p">,</span>   <span class="c1"># occasional</span>
            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span>
            <span class="s2">&quot;na&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n/a&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

    <span class="c1"># --- regexes (reuse yours if they exist globally) ------------------------</span>
    <span class="n">BANNER_SHELL_CLASS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|\s*class\s*=\s*([A-Za-z]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">PROJECT_NAME_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{\s*WikiProject\s*([^|}\n]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">CLASS_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|\s*class\s*=\s*([A-Za-z]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="n">IMPORTANCE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\|\s*importance\s*=\s*([A-Za-z]+)&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>

    <span class="c1"># --- 1) Try to get class from WikiProject banner shell -------------------</span>
    <span class="n">shell_class</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">shell_templates</span> <span class="o">=</span> <span class="n">_extract_templates_balanced</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="s2">&quot;{{WikiProject banner shell&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">shell_templates</span><span class="p">:</span>
        <span class="c1"># If multiple shells, just take the first one encountered</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">BANNER_SHELL_CLASS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">shell_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">shell_class</span> <span class="o">=</span> <span class="n">_normalize_class</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># --- 2) Collect WikiProject templates (balanced extraction) --------------</span>
    <span class="n">project_templates</span> <span class="o">=</span> <span class="n">_extract_templates_balanced</span><span class="p">(</span><span class="n">wikitext</span><span class="p">,</span> <span class="s2">&quot;{{WikiProject&quot;</span><span class="p">)</span>
    <span class="c1"># Filter out banner shell itself (it also begins with &quot;{{WikiProject ...&quot;)</span>
    <span class="n">project_templates</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">project_templates</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{\{\s*WikiProject\s+banner\s+shell\b&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">ukraine_template</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">first_template</span> <span class="o">=</span> <span class="n">project_templates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">project_templates</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">project_templates</span><span class="p">:</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">PROJECT_NAME_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pm</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">project_name</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># match &quot;Ukraine&quot; reliably (covers &quot;WikiProject Ukraine&quot;, &quot;WikiProject Ukraine-related&quot;, etc.)</span>
        <span class="k">if</span> <span class="s2">&quot;ukraine&quot;</span> <span class="ow">in</span> <span class="n">project_name</span><span class="p">:</span>
            <span class="n">ukraine_template</span> <span class="o">=</span> <span class="n">t</span>
            <span class="k">break</span>

    <span class="n">chosen_template</span> <span class="o">=</span> <span class="n">ukraine_template</span> <span class="ow">or</span> <span class="n">first_template</span>

    <span class="c1"># --- 3) Extract importance ONLY from chosen template ---------------------</span>
    <span class="n">importance_rating</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">class_rating</span> <span class="o">=</span> <span class="n">shell_class</span>  <span class="c1"># prefer shell class if available</span>

    <span class="k">if</span> <span class="n">chosen_template</span><span class="p">:</span>
        <span class="n">imp_match</span> <span class="o">=</span> <span class="n">IMPORTANCE_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">chosen_template</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">imp_match</span><span class="p">:</span>
            <span class="n">importance_rating</span> <span class="o">=</span> <span class="n">_normalize_importance</span><span class="p">(</span><span class="n">imp_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="c1"># If shell didn&#39;t provide class, fall back to chosen template class</span>
        <span class="k">if</span> <span class="n">class_rating</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">class_match</span> <span class="o">=</span> <span class="n">CLASS_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">chosen_template</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">class_match</span><span class="p">:</span>
                <span class="n">class_rating</span> <span class="o">=</span> <span class="n">_normalize_class</span><span class="p">(</span><span class="n">class_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="n">class_rating</span><span class="p">,</span>
        <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">importance_rating</span><span class="p">,</span>
    <span class="p">}</span>

<span class="c1"># Same idea as for the protection status</span>
<span class="k">def</span><span class="w"> </span><span class="nf">build_metadata_timeline</span><span class="p">(</span><span class="n">talk_revisions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of metadata changes:</span>
<span class="sd">    [</span>
<span class="sd">        {</span>
<span class="sd">            &quot;timestamp&quot;: &quot;...&quot;,</span>
<span class="sd">            &quot;rev_id&quot;: ...,</span>
<span class="sd">            &quot;class&quot;: &quot;C&quot;,</span>
<span class="sd">            &quot;importance&quot;: &quot;High&quot;,</span>
<span class="sd">        },</span>
<span class="sd">        ...</span>
<span class="sd">    ]</span>
<span class="sd">    Only stores metadata when it changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">talk_revisions</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">extract_metadata</span><span class="p">(</span><span class="n">rev</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">meta</span> <span class="o">!=</span> <span class="n">last_state</span><span class="p">:</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                <span class="s2">&quot;rev_id&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;rev_id&quot;</span><span class="p">],</span>
                <span class="o">**</span><span class="n">meta</span>
            <span class="p">})</span>
            <span class="n">last_state</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">timeline</span>    

<span class="k">def</span><span class="w"> </span><span class="nf">extract_article_metadata_timeline</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Fetching Talk Page revisions for: </span><span class="si">{</span><span class="n">article_title</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="n">talk_revs</span> <span class="o">=</span> <span class="n">fetch_talk_revisions</span><span class="p">(</span><span class="n">article_title</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">talk_revs</span><span class="p">)</span><span class="si">}</span><span class="s2"> talk revisions.&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Parsing metadata changes (Option B) ===&quot;</span><span class="p">)</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">build_metadata_timeline</span><span class="p">(</span><span class="n">talk_revs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata change points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeline</span>

<span class="c1"># We want now to convert each feature timeline into a dataframe for the matching process with our database.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">grade_timelines_to_dataframe</span><span class="p">(</span><span class="n">timelines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the grade timelines dict into a pandas DataFrame with:</span>
<span class="sd">    article | start | end | grade | diff_days</span>
<span class="sd">    Ensures all datetimes are UTC-aware to avoid subtraction errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">now_utc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">timelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Try to use article creation date if available</span>
            <span class="n">creation_info</span> <span class="o">=</span> <span class="n">get_article_creation_date</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">creation_info</span> <span class="ow">and</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">creation_info</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">creation_info</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

            <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">now_utc</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">now_utc</span><span class="p">,</span>
                <span class="s2">&quot;grade&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="n">diff_days</span>
            <span class="p">})</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

        <span class="c1"># Compute end timestamps</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">now_utc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="n">grade</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;class&quot;</span><span class="p">]</span>

            <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;grade&quot;</span><span class="p">:</span> <span class="n">grade</span> <span class="k">if</span> <span class="n">grade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="n">diff_days</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">importance_timelines_to_dataframe</span><span class="p">(</span><span class="n">timelines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the grade timelines dict into a pandas DataFrame with:</span>
<span class="sd">    article | start | end | grade | diff_days</span>
<span class="sd">    Ensures all datetimes are UTC-aware to avoid subtraction errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">now_utc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">timelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Try to use article creation date if available</span>
            <span class="n">creation_info</span> <span class="o">=</span> <span class="n">get_article_creation_date</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">creation_info</span> <span class="ow">and</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">creation_info</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">creation_info</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

            <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">now_utc</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">now_utc</span><span class="p">,</span>
                <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="n">diff_days</span>
            <span class="p">})</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

        <span class="c1"># Compute end timestamps</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">now_utc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="n">importance</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;importance&quot;</span><span class="p">)</span>

            <span class="n">diff_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;importance&quot;</span><span class="p">:</span> <span class="n">importance</span> <span class="k">if</span> <span class="n">importance</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="n">diff_days</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_grade_quality_dataframe</span><span class="p">(</span><span class="n">grade_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">wanna_save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gantt-style timeline representing quality-class evolution.</span>

<span class="sd">    Input:</span>
<span class="sd">        grade_df: DataFrame output of grade_timelines_to_dataframe with columns:</span>
<span class="sd">            - article</span>
<span class="sd">            - start</span>
<span class="sd">            - end</span>
<span class="sd">            - grade</span>
<span class="sd">            - diff_days (ignored)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">GRADE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;FA&quot;</span><span class="p">:</span> <span class="s2">&quot;navy&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FL&quot;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="s2">&quot;darkgreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GA&quot;</span><span class="p">:</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="s2">&quot;limegreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
        <span class="s2">&quot;START&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="s2">&quot;STUB&quot;</span><span class="p">:</span> <span class="s2">&quot;indianred&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LIST&quot;</span><span class="p">:</span> <span class="s2">&quot;lightskyblue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Unspecified&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">grade_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">grade_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;grade_df is empty. Nothing to plot.&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">grade_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">}</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grade_df is missing required columns: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Normalize datetimes</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>   <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Clean invalid intervals</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;After cleaning invalid intervals, nothing remains to plot.&quot;</span><span class="p">)</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;None&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;nan&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">})</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unspecified&quot;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


    <span class="n">articles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)))</span>

    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">for</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">articles</span><span class="p">):</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>

        <span class="c1"># Draw bars</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">end</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">grade</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">])</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">))],</span>
                <span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                <span class="n">facecolors</span><span class="o">=</span><span class="n">GRADE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grade</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
            <span class="p">)</span>

        <span class="n">first_start</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">first_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">y_pos</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">article</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>

    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">GRADE_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;NA&quot;</span><span class="p">)</span> 
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Quality Class&quot;</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wikipedia Article Quality Evolution Timeline&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save_fig</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;../../plots/Full Database/quality_timeline.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_importance_dataframe</span><span class="p">(</span><span class="n">importance_df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">wanna_save_fig</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gantt-style timeline representing importance-class evolution.</span>

<span class="sd">    Input:</span>
<span class="sd">        importance_df: DataFrame output of importance_timelines_to_dataframe with columns:</span>
<span class="sd">            - article</span>
<span class="sd">            - start</span>
<span class="sd">            - end</span>
<span class="sd">            - importance</span>
<span class="sd">            - diff_days (ignored)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">IMPORTANCE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Top&quot;</span><span class="p">:</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;High&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Mid&quot;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Low&quot;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Unspecified&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">importance_df</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;importance_df is empty. Nothing to plot.&quot;</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">importance_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="s2">&quot;importance&quot;</span><span class="p">}</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;importance_df is missing required columns: </span><span class="si">{</span><span class="nb">sorted</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Normalize datetimes</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span>   <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Clean invalid intervals</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;After cleaning invalid intervals, nothing remains to plot.&quot;</span><span class="p">)</span>

    <span class="c1"># Normalize importance strings a bit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_imp</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;top&quot;</span><span class="p">:</span> <span class="s2">&quot;Top&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;mid&quot;</span><span class="p">:</span> <span class="s2">&quot;Mid&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">:</span> <span class="s2">&quot;Mid&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;na&quot;</span><span class="p">:</span> <span class="s2">&quot;NA&quot;</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_norm_imp</span><span class="p">)</span>

    <span class="n">articles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.4</span><span class="p">)))</span>

    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">for</span> <span class="n">y_pos</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">articles</span><span class="p">):</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">end</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
            <span class="n">imp</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">))],</span>
                <span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                <span class="n">facecolors</span><span class="o">=</span><span class="n">IMPORTANCE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
            <span class="p">)</span>

        <span class="n">first_start</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">first_start</span><span class="p">)</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">y_pos</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">article</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>

    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="n">label</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">IMPORTANCE_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Importance Class&quot;</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wikipedia Article Importance Evolution Timeline&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save_fig</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">save_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="s2">&quot;../../plots/Full Database/importance_timeline.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">importance_grade_timelines</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># needed to build the timelines and build the plot </span>

<span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
    <span class="n">importance_grade_timelines</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_article_metadata_timeline</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">importance_df</span> <span class="o">=</span> <span class="n">importance_timelines_to_dataframe</span><span class="p">(</span><span class="n">importance_grade_timelines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Fetching Talk Page revisions for: 2004 Ukrainian presidential election ===
Fetched 89 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: 2014 Russian annexation of Crimea ===
Fetched 2387 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: 2014 pro-Russian unrest in Ukraine ===
Fetched 3241 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 9

=== Fetching Talk Page revisions for: 2022 Russian invasion of Ukraine ===
Fetched 260 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Abortion in Ukraine ===
Fetched 15 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Administrative divisions of Ukraine ===
Fetched 245 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Alexander II of Russia ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 12

=== Fetching Talk Page revisions for: Armed Forces of Ukraine ===
Fetched 242 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Bessarabia ===
Fetched 138 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Buddhism in Ukraine ===
Fetched 8 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Bukovina ===
Fetched 394 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: COVID-19 pandemic in Ukraine ===
Fetched 93 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Catherine the Great ===
Fetched 499 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 16

=== Fetching Talk Page revisions for: Censuses in Ukraine ===
Fetched 4 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Christianity in Russia ===
Fetched 14 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Christmas in Ukraine ===
Fetched 16 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Communist Party of the Soviet Union ===
Fetched 165 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 19

=== Fetching Talk Page revisions for: Crimea ===
Fetched 981 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 7

=== Fetching Talk Page revisions for: Crimean Tatars ===
Fetched 272 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Culture of Ukraine ===
Fetched 123 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Demographics of Ukraine ===
Fetched 145 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Dissolution of the Soviet Union ===
Fetched 225 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Eastern Front (World War I) ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Eastern Front (World War II) ===
Fetched 2285 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Economy of Ukraine ===
Fetched 59 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Education in Ukraine ===
Fetched 20 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Epiphanius I of Ukraine ===
Fetched 31 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Euromaidan ===
Fetched 1290 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Flag of Ukraine ===
Fetched 57 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Football in Ukraine ===
Fetched 10 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Foreign relations of Ukraine ===
Fetched 21 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Galicia (Eastern Europe) ===
Fetched 570 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Geography of Ukraine ===
Fetched 29 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Government of Ukraine ===
Fetched 48 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Government of the Ukrainian People&#39;s Republic in exile ===
Fetched 6 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: History of Christianity in Ukraine ===
Fetched 440 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: History of Crimea ===
Fetched 51 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: History of Kyiv ===
Fetched 223 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: History of Ukraine ===
Fetched 287 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 8

=== Fetching Talk Page revisions for: History of the Russian Orthodox Church ===
Fetched 25 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean_importance_df</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;importance&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">plot_importance_dataframe</span><span class="p">(</span><span class="n">importance_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8d6949559ecbe387e954448a537eae677af9e17ef3175bcfb624441a060fdf09.png" src="../_images/8d6949559ecbe387e954448a537eae677af9e17ef3175bcfb624441a060fdf09.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># safety checks</span>

<span class="c1"># importance_df[&#39;article&#39;].nunique()</span>
<span class="c1"># importance_df[&#39;importance&#39;].unique()</span>
<span class="c1"># importance_df[importance_df[&#39;diff_days&#39;] &lt; 0]</span>
<span class="n">importance_df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>article</th>
      <th>start</th>
      <th>end</th>
      <th>importance</th>
      <th>diff_days</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2004 Ukrainian presidential election</td>
      <td>2014-10-07 10:18:05+00:00</td>
      <td>2025-09-30 02:42:32+00:00</td>
      <td>High</td>
      <td>4010</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2004 Ukrainian presidential election</td>
      <td>2025-09-30 02:42:32+00:00</td>
      <td>2026-01-19 13:48:41.099693+00:00</td>
      <td>High</td>
      <td>111</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2014 Russian annexation of Crimea</td>
      <td>2014-03-19 20:35:01+00:00</td>
      <td>2014-03-20 13:26:10+00:00</td>
      <td>Low</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2014 Russian annexation of Crimea</td>
      <td>2014-03-20 13:26:10+00:00</td>
      <td>2014-12-19 13:46:12+00:00</td>
      <td>High</td>
      <td>274</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2014 Russian annexation of Crimea</td>
      <td>2014-12-19 13:46:12+00:00</td>
      <td>2023-11-24 03:06:27+00:00</td>
      <td>High</td>
      <td>3261</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>169</th>
      <td>History of Ukraine</td>
      <td>2025-02-01 00:05:17+00:00</td>
      <td>2026-01-19 13:48:41.099693+00:00</td>
      <td>Top</td>
      <td>352</td>
    </tr>
    <tr>
      <th>170</th>
      <td>History of the Russian Orthodox Church</td>
      <td>2013-06-06 15:36:01+00:00</td>
      <td>2013-07-06 16:02:33+00:00</td>
      <td>High</td>
      <td>30</td>
    </tr>
    <tr>
      <th>171</th>
      <td>History of the Russian Orthodox Church</td>
      <td>2013-07-06 16:02:33+00:00</td>
      <td>2021-02-20 08:40:04+00:00</td>
      <td>High</td>
      <td>2785</td>
    </tr>
    <tr>
      <th>172</th>
      <td>History of the Russian Orthodox Church</td>
      <td>2021-02-20 08:40:04+00:00</td>
      <td>2024-02-15 03:46:41+00:00</td>
      <td>Top</td>
      <td>1089</td>
    </tr>
    <tr>
      <th>173</th>
      <td>History of the Russian Orthodox Church</td>
      <td>2024-02-15 03:46:41+00:00</td>
      <td>2026-01-19 13:48:41.099693+00:00</td>
      <td>Top</td>
      <td>704</td>
    </tr>
  </tbody>
</table>
<p>174 rows × 5 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean_grade_df</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1">#grade_df_clean = clean_grade_df(grade_df)</span>
<span class="c1">#grade_df[&#39;article&#39;].nunique()</span>
<span class="n">grade_df</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="c1">#grade_df[grade_df[&#39;diff_days&#39;] &lt;0 ]</span>

<span class="n">plot_grade_quality_dataframe</span><span class="p">(</span><span class="n">grade_df</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b5bbe188ae987f1d243de4f6501a69e83f80de4b011c0ea74685623ee3140b72.png" src="../_images/b5bbe188ae987f1d243de4f6501a69e83f80de4b011c0ea74685623ee3140b72.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">quality_grade_timelines</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># needed to build the timelines and build the plot </span>

<span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
    <span class="n">quality_grade_timelines</span><span class="p">[</span><span class="n">title</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_article_metadata_timeline</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

<span class="n">grade_df</span> <span class="o">=</span> <span class="n">grade_timelines_to_dataframe</span><span class="p">(</span><span class="n">quality_grade_timelines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Fetching Talk Page revisions for: 2004 Ukrainian presidential election ===
Fetched 89 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: 2014 Russian annexation of Crimea ===
Fetched 2387 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: 2014 pro-Russian unrest in Ukraine ===
Fetched 3241 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 9

=== Fetching Talk Page revisions for: 2022 Russian invasion of Ukraine ===
Fetched 260 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Abortion in Ukraine ===
Fetched 15 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Administrative divisions of Ukraine ===
Fetched 245 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Alexander II of Russia ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 12

=== Fetching Talk Page revisions for: Armed Forces of Ukraine ===
Fetched 242 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Bessarabia ===
Fetched 138 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Buddhism in Ukraine ===
Fetched 8 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Bukovina ===
Fetched 394 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: COVID-19 pandemic in Ukraine ===
Fetched 93 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Catherine the Great ===
Fetched 499 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 16

=== Fetching Talk Page revisions for: Censuses in Ukraine ===
Fetched 4 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Christianity in Russia ===
Fetched 14 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Christmas in Ukraine ===
Fetched 16 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Communist Party of the Soviet Union ===
Fetched 165 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 19

=== Fetching Talk Page revisions for: Crimea ===
Fetched 981 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 7

=== Fetching Talk Page revisions for: Crimean Tatars ===
Fetched 272 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Culture of Ukraine ===
Fetched 123 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Demographics of Ukraine ===
Fetched 145 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Dissolution of the Soviet Union ===
Fetched 225 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Eastern Front (World War I) ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Eastern Front (World War II) ===
Fetched 2285 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Economy of Ukraine ===
Fetched 59 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Education in Ukraine ===
Fetched 20 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Epiphanius I of Ukraine ===
Fetched 31 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Euromaidan ===
Fetched 1290 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Flag of Ukraine ===
Fetched 57 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Football in Ukraine ===
Fetched 10 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Foreign relations of Ukraine ===
Fetched 21 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 3

=== Fetching Talk Page revisions for: Galicia (Eastern Europe) ===
Fetched 570 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Geography of Ukraine ===
Fetched 29 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Government of Ukraine ===
Fetched 48 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Government of the Ukrainian People&#39;s Republic in exile ===
Fetched 6 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: History of Christianity in Ukraine ===
Fetched 440 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: History of Crimea ===
Fetched 51 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: History of Kyiv ===
Fetched 223 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: History of Ukraine ===
Fetched 287 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 8

=== Fetching Talk Page revisions for: History of the Russian Orthodox Church ===
Fetched 25 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4
</pre></div>
</div>
</div>
</div>
</section>
<section id="vital-level">
<h1>Vital Level<a class="headerlink" href="#vital-level" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">WIKI_API</span> <span class="o">=</span> <span class="s2">&quot;https://en.wikipedia.org/w/api.php&quot;</span>
<span class="n">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;DH_Project/1.0 (maxime.garambois@epfl.ch)&quot;</span>
<span class="n">SLEEP</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="k">def</span><span class="w"> </span><span class="nf">request_api</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Send a request to the API with retry and user-agent.&quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">:</span> <span class="n">USER_AGENT</span><span class="p">}</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WIKI_API</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Retrying due to error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fetch_talk_revisions</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetch all wikitext revisions of the Talk:Article page.</span>
<span class="sd">    Returns a list of dicts: {rev_id, timestamp, content}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">talk_title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Talk:</span><span class="si">{</span><span class="n">article_title</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;query&quot;</span><span class="p">,</span>
        <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prop&quot;</span><span class="p">:</span> <span class="s2">&quot;revisions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;titles&quot;</span><span class="p">:</span> <span class="n">talk_title</span><span class="p">,</span>
        <span class="s2">&quot;rvprop&quot;</span><span class="p">:</span> <span class="s2">&quot;ids|timestamp|content&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvslots&quot;</span><span class="p">:</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rvlimit&quot;</span><span class="p">:</span> <span class="s2">&quot;500&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">revisions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cont</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">while</span> <span class="n">cont</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request_api</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="n">pages</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;query&quot;</span><span class="p">][</span><span class="s2">&quot;pages&quot;</span><span class="p">]</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">pages</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>

        <span class="k">if</span> <span class="s2">&quot;revisions&quot;</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">page</span><span class="p">[</span><span class="s2">&quot;revisions&quot;</span><span class="p">]:</span>
                <span class="n">revisions</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;rev_id&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;revid&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                    <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;slots&quot;</span><span class="p">][</span><span class="s2">&quot;main&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                <span class="p">})</span>

        <span class="k">if</span> <span class="s2">&quot;continue&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;continue&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cont</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">)</span>

    <span class="n">revisions</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">revisions</span>

<span class="c1"># We are defining some constants again to find the correct template where vital level is encoded in the raw text from</span>
<span class="c1"># the revisions of the articles Talk Page</span>
<span class="n">VITAL_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;\{\{\s*</span>
<span class="sd">        (?:Vital(?:\s+article)?)       </span>
<span class="sd">        \s*</span>
<span class="sd">        \|</span>
<span class="sd">        (?:</span>
<span class="sd">            level\s*=\s*([0-9])        </span>
<span class="sd">            |</span>
<span class="sd">            ([0-9])                    </span>
<span class="sd">        )</span>
<span class="sd">        .*?</span>
<span class="sd">        \}\}&quot;&quot;&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
<span class="p">)</span>

<span class="n">VITAL_TEMPLATE_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\{\{\s*Vital(?: article)?\s*\|[^}]*?(?:level\s*=\s*([0-9])|([0-9]))&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">VITAL_PARAM_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;\|\s*(?:vital|vital[-_]?(?:article|level|importance)|va)\s*=\s*([0-9]|yes)&quot;</span><span class="p">,</span>
    <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extract_vital_metadata</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract vital-level metadata from a talk page revision.&quot;&quot;&quot;</span>

    <span class="n">vital_rating</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Check explicit {{Vital article}} templates</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">VITAL_TEMPLATE_RE</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
        <span class="n">lvl_named</span><span class="p">,</span> <span class="n">lvl_positional</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
        <span class="n">lvl</span> <span class="o">=</span> <span class="n">lvl_named</span> <span class="ow">or</span> <span class="n">lvl_positional</span>
        <span class="k">if</span> <span class="n">lvl</span><span class="p">:</span>
            <span class="n">vital_rating</span> <span class="o">=</span> <span class="n">lvl</span>

    <span class="c1"># Check |vital=... parameters in banner shell or WikiProjects</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">VITAL_PARAM_RE</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">wikitext</span><span class="p">):</span>
        <span class="n">param</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
            <span class="n">vital_rating</span> <span class="o">=</span> <span class="s2">&quot;5&quot;</span>     <span class="c1"># convention</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vital_rating</span> <span class="o">=</span> <span class="n">param</span>   <span class="c1"># numeric 1–5</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;vital&quot;</span><span class="p">:</span> <span class="n">vital_rating</span><span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_vital_metadata_timeline</span><span class="p">(</span><span class="n">talk_revisions</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of metadata changes:</span>
<span class="sd">    [</span>
<span class="sd">        {</span>
<span class="sd">            &quot;timestamp&quot;: &quot;...&quot;,</span>
<span class="sd">            &quot;rev_id&quot;: ...,</span>
<span class="sd">            &quot;class&quot;: &quot;C&quot;,</span>
<span class="sd">            &quot;importance&quot;: &quot;High&quot;,</span>
<span class="sd">        },</span>
<span class="sd">        ...</span>
<span class="sd">    ]</span>
<span class="sd">    Only stores metadata when it changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_state</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;vital&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">rev</span> <span class="ow">in</span> <span class="n">talk_revisions</span><span class="p">:</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">extract_vital_metadata</span><span class="p">(</span><span class="n">rev</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">meta</span> <span class="o">!=</span> <span class="n">last_state</span><span class="p">:</span>
            <span class="n">timeline</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span>
                <span class="s2">&quot;rev_id&quot;</span><span class="p">:</span> <span class="n">rev</span><span class="p">[</span><span class="s2">&quot;rev_id&quot;</span><span class="p">],</span>
                <span class="o">**</span><span class="n">meta</span>
            <span class="p">})</span>
            <span class="n">last_state</span> <span class="o">=</span> <span class="n">meta</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">timeline</span>

<span class="k">def</span><span class="w"> </span><span class="nf">extract_article_vital_metadata_timeline</span><span class="p">(</span><span class="n">article_title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Fetching Talk Page revisions for: </span><span class="si">{</span><span class="n">article_title</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="n">talk_revs</span> <span class="o">=</span> <span class="n">fetch_talk_revisions</span><span class="p">(</span><span class="n">article_title</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fetched </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">talk_revs</span><span class="p">)</span><span class="si">}</span><span class="s2"> talk revisions.&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== Parsing metadata changes (Option B) ===&quot;</span><span class="p">)</span>
    <span class="n">timeline</span> <span class="o">=</span> <span class="n">build_vital_metadata_timeline</span><span class="p">(</span><span class="n">talk_revs</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Metadata change points: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">timeline</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">timeline</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vital_timelines_to_dataframe</span><span class="p">(</span><span class="n">timelines</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert the vital timelines dict into a pandas DataFrame with:</span>
<span class="sd">    article | article_created | start | end | vital | diff_days</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">now_utc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">timelines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">creation_info</span> <span class="o">=</span> <span class="n">get_article_creation_date</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">creation_info</span> <span class="ow">and</span> <span class="s2">&quot;timestamp&quot;</span> <span class="ow">in</span> <span class="n">creation_info</span><span class="p">:</span>
            <span class="n">creation_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">creation_info</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">creation_dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">NaT</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">creation_dt</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">now_utc</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;article_created&quot;</span><span class="p">:</span> <span class="n">creation_dt</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;vital&quot;</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>
            <span class="k">continue</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">changes</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">)</span>

        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">now_utc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="n">vital</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;Unspecified&quot;</span>

            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;article&quot;</span><span class="p">:</span> <span class="n">article</span><span class="p">,</span>
                <span class="s2">&quot;article_created&quot;</span><span class="p">:</span> <span class="n">creation_dt</span><span class="p">,</span>
                <span class="s2">&quot;start&quot;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
                <span class="s2">&quot;end&quot;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
                <span class="s2">&quot;vital&quot;</span><span class="p">:</span> <span class="n">vital</span><span class="p">,</span>
                <span class="s2">&quot;diff_days&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pd</span><span class="o">.</span><span class="n">notna</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="p">})</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_vital_level_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">wanna_save_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a Gantt-style timeline of Vital Level evolution.</span>
<span class="sd">    Only plots articles that have at least one specified vital level (1–5) at some point.</span>
<span class="sd">    Input: df with columns</span>
<span class="sd">        article | start | end | vital | diff_days</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">GRADE_COLORS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;limegreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span>
        <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;lightseagreen&quot;</span><span class="p">,</span>
        <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;darkslategray&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Unspecified&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>   <span class="c1"># no vital rating</span>
    <span class="p">}</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;coerce&quot;</span><span class="p">)</span>

    <span class="c1"># Clean invalid rows</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_norm_vital</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unspecified&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;vital_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_norm_vital</span><span class="p">)</span>

    <span class="n">keep_articles</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">)[</span><span class="s2">&quot;vital_key&quot;</span><span class="p">]</span>
          <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">keep_articles</span><span class="p">[</span><span class="n">keep_articles</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No articles with specified vital levels (1–5) to plot.&quot;</span><span class="p">)</span>

    <span class="n">articles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">articles</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>

    <span class="n">y_pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">height</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
        <span class="n">df_a</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_a</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">end</span>   <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
            <span class="n">vital_key</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;vital_key&quot;</span><span class="p">]</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">broken_barh</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">),</span>
                  <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">))],</span>
                <span class="p">(</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span>
                <span class="n">facecolors</span><span class="o">=</span><span class="n">GRADE_COLORS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vital_key</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">),</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;none&quot;</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">df_a</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">-</span> <span class="mi">50</span><span class="p">,</span>
            <span class="n">y_pos</span> <span class="o">+</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">article</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span>
        <span class="p">)</span>

        <span class="n">y_pos</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">spine</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">YearLocator</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">))</span>

    <span class="n">legend_handles</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Patch</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Unspecified&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="o">==</span> <span class="s2">&quot;Unspecified&quot;</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;Level </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">GRADE_COLORS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
        <span class="n">handles</span><span class="o">=</span><span class="n">legend_handles</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Vital Level&quot;</span><span class="p">,</span>
        <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">,</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Wikipedia Article Vital Level Evolution Timeline&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save_fig</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="s2">&quot;../../plots/Policy Analysis/vital_level_timeline.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
            <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vital_timelines</span><span class="o">=</span><span class="p">{}</span>

<span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
    
    <span class="n">vital_timelines</span><span class="p">[</span><span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="n">extract_article_vital_metadata_timeline</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

<span class="n">vital_df</span> <span class="o">=</span> <span class="n">vital_timelines_to_dataframe</span><span class="p">(</span><span class="n">vital_timelines</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Fetching Talk Page revisions for: 2004 Ukrainian presidential election ===
Fetched 89 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: 2014 Russian annexation of Crimea ===
Fetched 2387 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: 2014 pro-Russian unrest in Ukraine ===
Fetched 3241 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: 2022 Russian invasion of Ukraine ===
Fetched 260 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Abortion in Ukraine ===
Fetched 15 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Administrative divisions of Ukraine ===
Fetched 245 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Alexander II of Russia ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 5

=== Fetching Talk Page revisions for: Armed Forces of Ukraine ===
Fetched 242 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Bessarabia ===
Fetched 138 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Buddhism in Ukraine ===
Fetched 8 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Bukovina ===
Fetched 394 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: COVID-19 pandemic in Ukraine ===
Fetched 93 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Catherine the Great ===
Fetched 499 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 6

=== Fetching Talk Page revisions for: Censuses in Ukraine ===
Fetched 4 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Christianity in Russia ===
Fetched 14 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Christmas in Ukraine ===
Fetched 16 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Communist Party of the Soviet Union ===
Fetched 165 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Crimea ===
Fetched 981 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 6

=== Fetching Talk Page revisions for: Crimean Tatars ===
Fetched 272 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Culture of Ukraine ===
Fetched 123 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Demographics of Ukraine ===
Fetched 145 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Dissolution of the Soviet Union ===
Fetched 225 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Eastern Front (World War I) ===
Fetched 134 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Eastern Front (World War II) ===
Fetched 2285 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Economy of Ukraine ===
Fetched 59 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Education in Ukraine ===
Fetched 20 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Epiphanius I of Ukraine ===
Fetched 31 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Euromaidan ===
Fetched 1290 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Flag of Ukraine ===
Fetched 57 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 4

=== Fetching Talk Page revisions for: Football in Ukraine ===
Fetched 10 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Foreign relations of Ukraine ===
Fetched 21 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Galicia (Eastern Europe) ===
Fetched 570 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: Geography of Ukraine ===
Fetched 29 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 2

=== Fetching Talk Page revisions for: Government of Ukraine ===
Fetched 48 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: Government of the Ukrainian People&#39;s Republic in exile ===
Fetched 6 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: History of Christianity in Ukraine ===
Fetched 440 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: History of Crimea ===
Fetched 51 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 1

=== Fetching Talk Page revisions for: History of Kyiv ===
Fetched 223 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0

=== Fetching Talk Page revisions for: History of Ukraine ===
Fetched 287 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 10

=== Fetching Talk Page revisions for: History of the Russian Orthodox Church ===
Fetched 25 talk revisions.
=== Parsing metadata changes (Option B) ===
Metadata change points: 0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean_vital_df</span><span class="p">(</span><span class="n">dataframe</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;vital&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;vital&#39;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="kc">None</span><span class="p">:</span> <span class="s2">&quot;Unspecified&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="c1">#vital_df[&#39;article&#39;].nunique()</span>
<span class="c1">#vital_df[&#39;vital&#39;].unique()</span>
<span class="c1">#vital_df[vital_df[&#39;diff_days&#39;] &lt;0]</span>
<span class="c1">#vital_df = clean_vital_df(vital_df)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>article</th>
      <th>article_created</th>
      <th>start</th>
      <th>end</th>
      <th>vital</th>
      <th>diff_days</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_vital_level_dataframe</span><span class="p">(</span><span class="n">vital_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d3a55cc5adc1f003a0d9c240b385a3e344440542d1988f06fe9dc908bb2fdab3.png" src="../_images/d3a55cc5adc1f003a0d9c240b385a3e344440542d1988f06fe9dc908bb2fdab3.png" />
</div>
</div>
</section>
<section id="match-and-plot">
<h1>Match and Plot<a class="headerlink" href="#match-and-plot" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">match_features_with_df</span><span class="p">(</span><span class="n">grade_dataframe</span><span class="p">,</span> <span class="n">importance_dataframe</span><span class="p">,</span> <span class="n">vital_dataframe</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Step 1: convert date column</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># Step 2: assign importance based on timeline intervals</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">article</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span>
        <span class="n">date_df</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
    
        <span class="c1"># find the timeline rows for this article</span>
        <span class="n">grade_subset</span>      <span class="o">=</span> <span class="n">grade_dataframe</span><span class="p">[</span><span class="n">grade_dataframe</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span>
        <span class="n">importance_subset</span> <span class="o">=</span> <span class="n">importance_dataframe</span><span class="p">[</span><span class="n">importance_dataframe</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span>
        <span class="n">vital_subset</span> <span class="o">=</span> <span class="n">vital_dataframe</span><span class="p">[</span><span class="n">vital_dataframe</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span>
    
        <span class="c1"># loop over intervals for this article for grade_dataframe</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">grade_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">grade_start</span> <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">grade_end</span>   <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
    
            <span class="c1"># check if the date is within that interval</span>
            <span class="k">if</span> <span class="n">grade_start</span> <span class="o">&lt;=</span> <span class="n">date_df</span> <span class="o">&lt;</span> <span class="n">grade_end</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span>
                <span class="k">break</span>  

        <span class="c1"># loop over intervals for this article for importance_dataframe</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">ti</span> <span class="ow">in</span> <span class="n">importance_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">importance_start</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">importance_end</span>   <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
    
            <span class="c1"># check if the date is within that interval</span>
            <span class="k">if</span> <span class="n">importance_start</span> <span class="o">&lt;=</span> <span class="n">date_df</span> <span class="o">&lt;</span> <span class="n">importance_end</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span>
                <span class="k">break</span>    

        <span class="c1"># loop over intervals for this article for vital_dataframe</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tv</span> <span class="ow">in</span> <span class="n">vital_subset</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">vital_start</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">]</span>
            <span class="n">vital_end</span>   <span class="o">=</span> <span class="n">tv</span><span class="p">[</span><span class="s2">&quot;end&quot;</span><span class="p">]</span>
    
            <span class="c1"># check if the date is within that interval</span>
            <span class="k">if</span> <span class="n">vital_start</span> <span class="o">&lt;=</span> <span class="n">date_df</span> <span class="o">&lt;</span> <span class="n">vital_end</span><span class="p">:</span>
                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s2">&quot;vital&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tv</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">]</span>
                <span class="k">break</span>  

    <span class="k">return</span> <span class="n">df</span>

<span class="n">df_final</span> <span class="o">=</span> <span class="n">match_features_with_df</span><span class="p">(</span><span class="n">grade_df</span><span class="p">,</span> <span class="n">importance_df</span><span class="p">,</span> <span class="n">vital_df</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_weap_vs_importance</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">wanna_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distribution_type</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
    
    <span class="n">custom_palette</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;#ed2939&quot;</span><span class="p">,</span>             
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>              
        <span class="s2">&quot;Top&quot;</span><span class="p">:</span> <span class="s2">&quot;magenta&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;High&quot;</span><span class="p">:</span> <span class="s2">&quot;orange&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;Mid&quot;</span><span class="p">:</span> <span class="s2">&quot;lime&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;Low&quot;</span><span class="p">:</span> <span class="s2">&quot;royalblue&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;Unspecified&quot;</span><span class="p">:</span> <span class="s2">&quot;lightgray&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    
    <span class="n">df_sub</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;weaponised&#39;</span><span class="p">,</span> <span class="s1">&#39;importance&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;Low&quot;</span><span class="p">,</span> <span class="s2">&quot;Mid&quot;</span><span class="p">,</span> <span class="s2">&quot;High&quot;</span><span class="p">,</span> <span class="s2">&quot;Top&quot;</span><span class="p">]</span>

    <span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;importance&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;weaponised&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distribution_type</span> <span class="o">==</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Percentage (%)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Distribution of Weaponised vs Not Weaponised Edits by Importance Level&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># default = count</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edit Count by Importance Level and Weaponisation Status&quot;</span>
    
    <span class="n">weapon_palette</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Weaponised&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Not Weaponised&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">pivot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">weapon_palette</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Importance Level&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Weaponised Status&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Importance_vs_Weaponisation_</span><span class="si">{</span><span class="n">distribution_type</span><span class="si">}</span><span class="s2">.png&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;../../plots/Policy Analysis/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_weap_vs_grade</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">wanna_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distribution_type</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
    
    <span class="n">custom_palette</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;#ed2939&quot;</span><span class="p">,</span>             
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>              
    <span class="p">}</span>
    
    <span class="n">df_sub</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;weaponised&#39;</span><span class="p">,</span> <span class="s1">&#39;grade&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;STUB&quot;</span><span class="p">,</span> <span class="s2">&quot;START&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;GA&quot;</span><span class="p">,</span> <span class="s2">&quot;FL&quot;</span><span class="p">,</span> <span class="s2">&quot;FA&quot;</span><span class="p">]</span>

    <span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;grade&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;grade&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;weaponised&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distribution_type</span> <span class="o">==</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Percentage (%)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Distribution of Weaponised vs Not Weaponised Edits by Article Quality Grade&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edit Count by Article Quality Grade and Weaponisation Status&quot;</span>
    
    <span class="n">weapon_palette</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Weaponised&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Not Weaponised&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">pivot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">weapon_palette</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Grade Level&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Weaponised Status&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;../../plots/Policy Analysis/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_weap_vs_protection</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">wanna_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distribution_type</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
    
    <span class="n">custom_palette</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;#ed2939&quot;</span><span class="p">,</span>             
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>              
    <span class="p">}</span>
    
    <span class="n">df_sub</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;weaponised&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;unprotected&quot;</span><span class="p">,</span> <span class="s2">&quot;semi-protected&quot;</span><span class="p">,</span> <span class="s2">&quot;extended-protected&quot;</span><span class="p">,</span> <span class="s2">&quot;fully protected&quot;</span><span class="p">]</span>

    <span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;weaponised&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distribution_type</span> <span class="o">==</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Percentage (%)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Distribution of Weaponised vs Not Weaponised Edits by Protection Status&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edit Count by Protection Status and Weaponisation Status&quot;</span>
    
    <span class="n">weapon_palette</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Weaponised&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Not Weaponised&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">pivot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">weapon_palette</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Protection Level&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Weaponised Status&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;../../plots/Policy Analysis/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plot_weap_vs_vital</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">wanna_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">distribution_type</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">):</span>
    
    <span class="n">custom_palette</span> <span class="o">=</span> <span class="p">{</span> 
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;#ed2939&quot;</span><span class="p">,</span>             
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span>              
    <span class="p">}</span>
    
    <span class="n">df_sub</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;weaponised&#39;</span><span class="p">,</span> <span class="s1">&#39;vital&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Unspecified&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">]</span>

    <span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_plot</span><span class="p">[</span><span class="s2">&quot;vital&quot;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pivot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;vital&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;weaponised&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>
    <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">order</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">distribution_type</span> <span class="o">==</span> <span class="s2">&quot;percentage&quot;</span><span class="p">:</span>
        <span class="n">pivot</span> <span class="o">=</span> <span class="n">pivot</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">pivot</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Percentage (%)&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Distribution of Weaponised vs Not Weaponised Edits by Vital Level&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_label</span> <span class="o">=</span> <span class="s2">&quot;Count&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Edit Count by Vital Level and Weaponisation Status&quot;</span>
    
    <span class="n">weapon_palette</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Weaponised&quot;</span><span class="p">],</span>
        <span class="s2">&quot;Not Weaponised&quot;</span><span class="p">:</span> <span class="n">custom_palette</span><span class="p">[</span><span class="s2">&quot;Not Weaponised&quot;</span><span class="p">]</span>
    <span class="p">}</span>
    
    <span class="n">pivot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> 
        <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
        <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="n">weapon_palette</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pivot</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Vital Level&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Weaponised Status&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">wanna_save</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;../../plots/Policy Analysis/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_weap_vs_protection</span><span class="p">(</span><span class="n">df_match_protect</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b70aa3cf03b6eccffbdd60f19a0ed09330cdd53d18249801e82040c534a3ee36.png" src="../_images/b70aa3cf03b6eccffbdd60f19a0ed09330cdd53d18249801e82040c534a3ee36.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_weap_vs_importance</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/99d53beafcffcff93cc12ee4aae4376a83a6422bcc74fdd43d99ca374aebd83a.png" src="../_images/99d53beafcffcff93cc12ee4aae4376a83a6422bcc74fdd43d99ca374aebd83a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_weap_vs_grade</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b9f350b590b110fe9a62ee83b024bc1e7027329a5e8cf782257b2e2171334cba.png" src="../_images/b9f350b590b110fe9a62ee83b024bc1e7027329a5e8cf782257b2e2171334cba.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_weap_vs_vital</span><span class="p">(</span><span class="n">df_final</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;percentage&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/77fb13d6044c539d458f009b93bd047a9d56b1a0f2de7518b8a72e97f6cf76e1.png" src="../_images/77fb13d6044c539d458f009b93bd047a9d56b1a0f2de7518b8a72e97f6cf76e1.png" />
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "ada"
        },
        kernelOptions: {
            name: "ada",
            path: "./policy"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ada'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="policy_in_nutshell.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">&lt;no title&gt;</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Protection Status</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#importance-and-grades-analysis">Importance and Grades Analysis</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#vital-level">Vital Level</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#match-and-plot">Match and Plot</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Maxime Garambois
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>